<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BB84 Quantum Chat</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            color: #e4e4e7;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            max-height: 800px;
            background: #16213e;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
            overflow: hidden;
            display: flex;
        }

        #auth-screen {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
        }

        .auth-box {
            width: 100%;
            max-width: 400px;
            background: rgba(22, 33, 62, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 18px;
            padding: 32px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            position: relative;
            z-index: 1;
        }

        .auth-box h2 {
            text-align: center;
            color: #fafafa;
            margin-bottom: 24px;
            font-size: 2rem;
            font-weight: 700;
        }

        .auth-box input {
            width: 100%;
            padding: 14px 18px;
            margin-bottom: 16px;
            border: 2px solid #27272a;
            border-radius: 12px;
            background: #0f1419;
            color: #e4e4e7;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
        }

        .auth-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .auth-box input::placeholder {
            color: #71717a;
        }

        .auth-box button {
            width: 100%;
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fafafa;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
        }

        .auth-box button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .auth-toggle {
            text-align: center;
            margin-top: 16px;
            color: #fafafa;
            font-size: 14px;
        }

        .auth-toggle a {
            color: #fafafa;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
        }

        .error {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            margin-top: 16px;
            font-size: 14px;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hidden {
            display: none !important;
        }

        #chat-screen {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: row;
        }

        #users {
            width: 320px;
            min-width: 280px;
            border-right: 1px solid #27272a;
            background: #0f1419;
            display: flex;
            flex-direction: column;
        }

        #users h3 {
            padding: 24px;
            margin: 0;
            border-bottom: 1px solid #27272a;
            font-size: 1rem;
            color: #a1a1aa;
            background: #16213e;
            font-weight: 600;
        }

        .connection-status {
            padding: 4px 24px;
            font-size: 0.75rem;
            color: #ef4444;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 600;
            border-bottom: 1px solid #27272a;
            background: rgba(239, 68, 68, 0.1);
        }

        .connection-status.connected {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        #userList {
            list-style-type: none;
            padding: 8px;
            margin: 0;
            overflow-y: auto;
            flex: 1;
        }

        #userList li {
            padding: 14px 16px;
            cursor: pointer;
            border-radius: 12px;
            margin-bottom: 4px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #e4e4e7;
        }

        #userList li::before {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
            box-shadow: 0 0 8px #10b981;
            flex-shrink: 0;
        }

        #userList li:hover {
            background: rgba(102, 126, 234, 0.08);
            transform: translateX(4px);
        }

        #userList li.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fafafa;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
        }

        #userList li.active::before {
            background: #fafafa;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
        }

        #chat-window {
            flex: 1;
            display: none;
            flex-direction: column;
            background: #16213e;
        }

        #chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px;
            border-bottom: 1px solid #27272a;
            background: #16213e;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        #chat-header h3 {
            margin: 0;
            font-size: 1.3rem;
            color: #e4e4e7;
            font-weight: 600;
        }

        #clear-history-btn {
            background: #ef4444;
            color: #fafafa;
            border: none;
            padding: 10px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        #clear-history-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: #0f1419;
        }

        #messages::-webkit-scrollbar {
            width: 8px;
        }

        #messages::-webkit-scrollbar-thumb {
            background: #27272a;
            border-radius: 4px;
        }

        .message {
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 18px;
            margin-bottom: 8px;
            line-height: 1.5;
            word-wrap: break-word;
            position: relative;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .message.sent {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fafafa;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.received {
            background: #1a1f2e;
            color: #e4e4e7;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border: 1px solid #27272a;
        }

        .sender-name {
            font-weight: 600;
            font-size: 0.75rem;
            margin-bottom: 4px;
            display: block;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message p {
            margin: 0;
        }

        #welcome {
            text-align: center;
            color: #71717a;
            margin: auto;
            font-size: 1.1rem;
            padding: 32px;
        }

        #input-area {
            display: flex;
            padding: 24px;
            border-top: 1px solid #27272a;
            background: #16213e;
            gap: 16px;
        }

        #input-area input {
            flex: 1;
            padding: 14px 20px;
            border: 2px solid #27272a;
            border-radius: 24px;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            background: #0f1419;
            color: #e4e4e7;
        }

        #input-area input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #input-area input::placeholder {
            color: #71717a;
        }

        #input-area button {
            padding: 14px 28px;
            border: none;
            border-radius: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fafafa;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
        }

        #input-area button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        @media (max-width: 768px) {
            .container {
                width: 100vw;
                height: 100vh;
                border-radius: 0;
                max-height: none;
            }

            #users {
                width: 100%;
                max-width: none;
                border-right: none;
                border-bottom: 1px solid #27272a;
            }

            #chat-screen {
                flex-direction: column;
            }

            .message {
                max-width: 85%;
            }
        }
    </style>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js" crossorigin="anonymous" defer></script>
    <script defer>
        document.addEventListener("DOMContentLoaded", () => {
            const socket = io({
                transports: ['polling', 'websocket'],
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                reconnectionAttempts: 10,
                timeout: 20000,
                forceNew: false,
                autoConnect: true
            });
            let username = null;
            let currentRecipient = null;
            const sharedKeys = {};

            const byId = (id) => document.getElementById(id);

            const authScreens = {
                login: byId("login-box"),
                register: byId("register-box")
            };

            // Check for existing session on page load
            async function checkExistingSession() {
                try {
                    const response = await fetch('/check_session');
                    const data = await response.json();
                    if (data.logged_in) {
                        console.log("Found existing session for:", data.username);
                        startChatSession(data.username);
                        return true;
                    }
                } catch (error) {
                    console.error("Error checking session:", error);
                }
                return false;
            }

            function setError(element, message) {
                if (element) {
                    element.textContent = message || "";
                }
            }

            // Check session immediately when page loads
            checkExistingSession();

            function xorCipher(text, key) {
                if (!key) return "[DECRYPTION KEY MISSING]";
                const keyBits = key.split("").map(Number);
                const keyLen = keyBits.length;
                try {
                    return text.split("").map((ch, i) =>
                        String.fromCharCode(ch.charCodeAt(0) ^ keyBits[i % keyLen])
                    ).join("");
                } catch (error) {
                    console.error("Cipher error", error);
                    return "[DECRYPTION FAILED]";
                }
            }

            function appendMessage(sender, message) {
                const msgDiv = document.createElement("div");
                msgDiv.className = "message " + (sender === username ? "sent" : "received");

                const senderSpan = document.createElement("span");
                senderSpan.className = "sender-name";
                senderSpan.textContent = sender;

                const msgContent = document.createElement("p");
                msgContent.textContent = message;

                msgDiv.appendChild(senderSpan);
                msgDiv.appendChild(msgContent);

                const messagesContainer = byId("messages");
                messagesContainer.appendChild(msgDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            function toggleAuth(mode) {
                if (!authScreens[mode]) return;
                Object.keys(authScreens).forEach((key) => {
                    authScreens[key].classList.toggle("hidden", key !== mode);
                });
                setError(byId("login-error"), "");
                setError(byId("register-error"), "");
            }

            async function performAuth(endpoint, user, pass, errorEl) {
                if (!user || !pass) {
                    setError(errorEl, "Please fill in all fields");
                    return;
                }

                try {
                    const response = await fetch(endpoint, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ username: user, password: pass })
                    });

                    const data = await response.json();
                    if (data.success) {
                        startChatSession(data.username || user);
                    } else {
                        setError(errorEl, data.error || "Authentication failed");
                    }
                } catch (error) {
                    console.error("Auth error", error);
                    setError(errorEl, "Unable to reach the server. Please try again.");
                }
            }

            function startChatSession(user) {
                username = user;
                byId("auth-screen").classList.add("hidden");
                byId("chat-screen").style.display = "flex";
                byId("messages").innerHTML = "<p id='welcome'>Select a user to start chatting</p>";
                socket.emit("register_user", username);
            }

            function clearChatHistory() {
                if (currentRecipient && confirm(`Clear all chat history with ${currentRecipient}?`)) {
                    socket.emit("clear_history", { user1: username, user2: currentRecipient });
                }
            }

            function updateConnectionStatus(connected) {
                const statusEl = byId("connection-status");
                statusEl.textContent = connected ? "Connected" : "Disconnected";
                statusEl.classList.toggle("connected", connected);
                statusEl.classList.remove("hidden");
            }

            function sendMessage() {
                const input = byId("messageInput");
                const text = input.value.trim();
                if (text && currentRecipient) {
                    socket.emit("send_message", {
                        sender: username,
                        recipient: currentRecipient,
                        message: text
                    });
                    input.value = "";
                    input.focus();
                }
            }

            function handleKey(event) {
                if (event.key === "Enter") {
                    sendMessage();
                }
            }

            // Socket wiring
            socket.on("connect", () => {
                console.log("âœ… Socket.IO connected!");
                updateConnectionStatus(true);
                if (username) {
                    socket.emit("register_user", username);
                }
            });

            socket.on("disconnect", (reason) => {
                console.log("âŒ Socket.IO disconnected. Reason:", reason);
                updateConnectionStatus(false);
            });

            socket.on("connect_error", (error) => {
                console.error("ðŸ”´ Socket connection error:", error.message);
                console.error("Transport:", error.transport);
                updateConnectionStatus(false);
            });

            socket.on("error", (error) => {
                console.error("ðŸ”´ Socket error:", error);
            });

            socket.on("reconnect_attempt", (attemptNumber) => {
                console.log("ðŸ”„ Reconnection attempt #" + attemptNumber);
            });

            socket.on("reconnect", (attemptNumber) => {
                console.log("âœ… Reconnected after " + attemptNumber + " attempts");
                updateConnectionStatus(true);
                if (username) {
                    socket.emit("register_user", username);
                }
            });

            socket.on("update_users", (users) => {
                const userList = byId("userList");
                userList.innerHTML = "";

                const countEl = byId("user-count");
                if (countEl) countEl.textContent = `(${users.length})`;

                let recipientStillOnline = false;
                users.forEach((user) => {
                    if (user === username) return;
                    if (user === currentRecipient) recipientStillOnline = true;

                    const li = document.createElement("li");
                    li.textContent = user;
                    if (user === currentRecipient) li.classList.add("active");
                    li.onclick = () => {
                        if (currentRecipient === user) return;
                        currentRecipient = user;
                        document.querySelectorAll("#userList li").forEach((item) => item.classList.remove("active"));
                        li.classList.add("active");
                        byId("chat-partner-name").textContent = `Chat with ${currentRecipient}`;
                        byId("messages").innerHTML = "";
                        byId("chat-window").style.display = "flex";
                        socket.emit("get_history", { user1: username, user2: currentRecipient });
                    };
                    userList.appendChild(li);
                });

                if (!recipientStillOnline) {
                    currentRecipient = null;
                    byId("chat-window").style.display = "none";
                }
            });

            socket.on("chat_history", ({ history, key }) => {
                if (currentRecipient) {
                    sharedKeys[currentRecipient] = key;
                    const messagesEl = byId("messages");
                    messagesEl.innerHTML = "";
                    if (!history.length) {
                        messagesEl.innerHTML = "<p id='welcome'>No messages yet. Say hi! ðŸ‘‹</p>";
                    } else {
                        history.forEach((msg) => appendMessage(msg.sender, msg.message));
                    }
                }
            });

            socket.on("history_cleared", () => {
                if (currentRecipient) {
                    byId("messages").innerHTML = "<p id='welcome'>Chat history was cleared.</p>";
                }
            });

            socket.on("receive_message", (data) => {
                const partner = data.sender === username ? currentRecipient : data.sender;
                if (partner && data.key) {
                    sharedKeys[partner] = data.key;
                }

                let displayMsg = data.message;
                if (data.sender !== username) {
                    const key = sharedKeys[data.sender];
                    displayMsg = xorCipher(data.message, key);
                }

                if (data.sender === currentRecipient || (data.sender === username && partner === currentRecipient)) {
                    appendMessage(data.sender, displayMsg);
                }
            });

            // Expose helpers globally for button handlers
            window.login = () => performAuth(
                "/login",
                byId("login-username").value.trim(),
                byId("login-password").value.trim(),
                byId("login-error")
            );

            window.register = () => performAuth(
                "/register",
                byId("register-username").value.trim(),
                byId("register-password").value.trim(),
                byId("register-error")
            );

            window.handleLogout = async () => {
                try {
                    await fetch('/logout', { method: 'POST' });
                    socket.disconnect();
                    location.reload();
                } catch (error) {
                    console.error("Logout error:", error);
                    location.reload();
                }
            };

            window.toggleAuth = toggleAuth;
            window.clearChatHistory = clearChatHistory;
            window.sendMessage = sendMessage;
            window.handleKey = handleKey;
        });
    </script>
</head>

<body>
    <div class="container">
        <div id="auth-screen">
            <div id="login-box" class="auth-box">
                <h2>Welcome Back</h2>
                <input id="login-username" type="text" placeholder="Username" autocomplete="username" required>
                <input id="login-password" type="password" placeholder="Password" autocomplete="current-password" required>
                <button type="button" onclick="login()">Sign In</button>
                <p class="auth-toggle">Don't have an account?
                    <a role="button" tabindex="0" onclick="toggleAuth('register')">Sign Up</a>
                </p>
                <p id="login-error" class="error" aria-live="assertive"></p>
            </div>

            <div id="register-box" class="auth-box hidden">
                <h2>Create Account</h2>
                <input id="register-username" type="text" placeholder="Username" autocomplete="username" required>
                <input id="register-password" type="password" placeholder="Password" autocomplete="new-password" required>
                <button type="button" onclick="register()">Sign Up</button>
                <p class="auth-toggle">Already have an account?
                    <a role="button" tabindex="0" onclick="toggleAuth('login')">Sign In</a>
                </p>
                <p id="register-error" class="error" aria-live="assertive"></p>
            </div>
        </div>

        <div id="chat-screen">
            <div id="users">
                <h3 id="current-user-header">Online Users <span id="user-count">(0)</span></h3>
                <div id="connection-status" class="connection-status hidden">Disconnected</div>
                <ul id="userList"></ul>
                <button id="logout-btn" type="button" onclick="handleLogout()" style="margin: 12px; padding: 10px; background: #ef4444; color: #fff; border: none; border-radius: 8px; cursor: pointer;">Logout</button>
            </div>
            <div id="chat-window">
                <div id="chat-header">
                    <h3 id="chat-partner-name">Select a user</h3>
                    <button id="clear-history-btn" type="button" onclick="clearChatHistory()">Clear History</button>
                </div>
                <div id="messages">
                    <p id="welcome">Select a user to start chatting</p>
                </div>
                <div id="input-area">
                    <input id="messageInput" type="text" placeholder="Type a message..." onkeydown="handleKey(event)">
                    <button type="button" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>
